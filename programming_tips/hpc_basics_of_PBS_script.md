# PBSスクリプトの基本

PBSスクリプトは、シェルスクリプトの中にPBSのディレクティブを含んだものです。これによりPBSシステムがジョブをどのように扱うべきかを理解します。

### PBSディレクティブの例

- `#PBS -q <queue_name>`: ジョブを投入するキューを指定します。

  - JAISTの場合だと`SINGLE`といった名称になります。これはKAGAYAKIのシステム管理者によって設定されるもので、キューにどのようなものがあるかということはシステム管理者が用意したドキュメントを見る必要があります。キュー毎に設定されるポリシーには

    - 実行時間の制限: 短時間のジョブ用、長時間のジョブ用など複数のキューが用意される
    - リソースの制限: 使用できるCPUの数、メモリの量、GPUの使用の有無など
    - 優先度: キューによっては、他のキューよりも高い優先度が設定されている事がある。これにより研究の重要性や緊急性に基づいてジョブを優先的に実行することが出来るようになる
    - アクセス制限: 特定のキューは特定のユーザーに限定されている事がある

    といったものがある。

- `#PBS -l select=<N>:ncpus=<M>:mem=<X>gb`: ノード数、CPU数、メモリの要求を指定します

  - JAISTのMPIの場合:
    `-l select=1:ncpus=8:mpiprocs=8`
    といった感じで選ぶことが出来ます。
    
  - JAISTのGPUの場合:
    `-l select=1:ngpus=1`
    これはGPUを1枚利用する場合。
    `-l select=2:ngpus=1`
    これはGPUを2枚利用する場合。
    `-l select=4:ngpus=1`
    これはGPUを4枚利用する場合。

    `ngpus`はいずれの場合でも1になっていることに注意すること。

- `#PBS -N <job_name>`: ジョブの名前を設定します

- `#PBS -o <path_to_output_file>`: 標準出力を保存するファイルのパスを指定します

- `#PBS -e <path_to_error_file>`: 標準エラーを保存するファイルのパスを指定します

- `#PBS -j <oe_or_eo>`: 標準出力と標準エラー出力を同じファイルにマージして出力します

  ```bash
  #PBS -j oe
  #PBS -o /home/usr/job_output.log
  ```

  - 上記設定だと、`/home/usr/job_output.log`に標準出力と標準エラー出力の両方が記録されます。
    - JAISTの場合だとデフォルトでログを落とす場所にはアクセス制限がかかっていた気がするので、自分にアクセス権のあるディレクトリにファイルをお落とすように指定する必要がある

- `#PBS -n`: 標準出力と標準エラー出力を別々のファイルに出力します。これがデフォルトの動作です。

- `#PBS -m abe`: ジョブの開始、終了、異常終了時にメールで通知する設定です。

- `-I`: インタラクティブモード(対話モード)で実行するために使用します。実験やデバッグなど試行錯誤が必要な作業をする際に非常に便利です。

  - インタラクティブモードで利用するため、PBSスクリプトの中にPBSディレクティブとして入れ込むというよりかは、コマンドライン上から以下のようなコマンドを実行して、対象とする計算機のオペレーション権限を取得するのが一般的な使い方ではないかと思う。
    ```bash
    $ qsub -I -l select=1:ncpus=4 -q SMALL
    ```

- `-X`: X11 forwarding
  X11フォワーディングを有効にし、GUIアプリケーションをリモートマシンからローカルマシンのXサーバーに転送できるようにするために使用します。

  - こちらもGUIを使う作業をする為に用いるので、PBSスクリプトの中に入れ込むのではなく、上述の`-I`オプションと組み合わせてインタラクティブモードで利用することになります。以下に使用例を示します。
    ```bash
    $ qsub -I -X -q GPU-1 -l select=1:ngpus=1
    ```

    


### ジョブスクリプトの例

```bash
#!/bin/bash
#PBS -N my_job
#PBS -q batch
#PBS -l select=1:ncpus=4:mem=16gb
#PBS -o /home/user/output.txt
#PBS -e /home/user/error.txt

module load python/3.8
cd /home/user/myproject
python myscript.py
```

### ジョブの投入

ジョブをスケジューラに投入するには、`qsub` コマンドを使用します。

```bash
$ qsub script.sh
```

### ジョブの状態確認

ジョブの状態を確認するには `qstat` コマンドを使用します。

```bash
$ qstat
```

### ジョブのキャンセル

ジョブをキャンセルしたい場合は、`qdel` コマンドを使用します。ジョブIDは `qstat` で確認できます。

```bash
$ qdel job_id
```

### ヘルプの表示

PBSの各コマンドについてのヘルプを表示するには、コマンドに `-h` オプションを付けて実行します。

```bash
$ qsub -h
```

これらがPBSの基本的な使い方です。スパコンやクラスターの具体的な環境によって、細かいオプションや設定が異なる場合があるため、具体的なシステムのドキュメントも参照すると良いでしょう。